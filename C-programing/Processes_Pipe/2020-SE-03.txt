–ó–∞–¥. 119 2020-SE-03 –ù–∞–ø–∏—à–µ—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–∞ –Ω–∞ C, –∫–æ—è—Ç–æ –ø—Ä–∏–µ–º–∞ –µ–¥–∏–Ω –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–µ–Ω –ø–æ–∑–∏—Ü–∏–æ–Ω–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—ä—Ä -
–∏–º–µ –Ω–∞ —Ñ–∞–π–ª. –§–∞–π–ª—ä—Ç —Å–µ —Å—ä—Å—Ç–æ–∏ –æ—Ç –Ω–µ –ø–æ–≤–µ—á–µ –æ—Ç 8 –Ω–∞—Ä–µ–¥–µ–Ω–∏ —Ç—Ä–æ–π–∫–∏ –µ–ª–µ–º–µ–Ω—Ç–∏:
‚Ä¢ –∏–º–µ –Ω–∞ —Ñ–∞–π–ª ‚Äì —Ç–æ—á–Ω–æ 8 –±–∞–π—Ç–∞, –ø–æ—Å–ª–µ–¥–Ω–∏—è—Ç –æ—Ç –∫–æ–∏—Ç–æ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ –µ 0x00. –ê–∫–æ –∏–º–µ—Ç–æ –µ –ø–æ-–∫—ä—Å–æ –æ—Ç
7 –∑–Ω–∞–∫–∞, –∏–∑–ª–∏—à–Ω–∏—Ç–µ –±–∞–π—Ç–æ–≤–µ —Å–∞ 0x00;
‚Ä¢ offset ‚Äì uint32_t, –∫–æ–π—Ç–æ –¥–∞–≤–∞ –ø–æ—Ä–µ–¥–µ–Ω –Ω–æ–º–µ—Ä –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç (—Å–ø—Ä—è–º–æ ùëÅ0) –≤—ä–≤ —Ñ–∞–π–ª–∞;
‚Ä¢ length ‚Äì uint32_t, –∫–æ–π—Ç–æ –¥–∞–≤–∞ –±—Ä–æ–π –µ–ª–µ–º–µ–Ω—Ç–∏.
–ó–∞ –≤—Å—è–∫–∞ –Ω–∞—Ä–µ–¥–µ–Ω–∞ —Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–∞—Ç–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –ø—É—Å–Ω–µ child –ø—Ä–æ—Ü–µ—Å, –∫–æ–π—Ç–æ –¥–∞ XOR-–Ω–µ (–æ–±—Ä–∞–±–æ—Ç–∏ —Å –∏–∑–∫–ª—é—á–≤–∞—â–æ–∏–ª–∏) 
–µ–ª–µ–º–µ–Ω—Ç–∏—Ç–µ (uint16_t) –æ—Ç —Å—ä–æ—Ç–≤–µ—Ç–Ω–∏—è —Ñ–∞–π–ª –µ–¥–∏–Ω —Å—ä—Å –¥—Ä—É–≥, –∏ –¥–∞ –≤—ä—Ä–Ω–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞ –Ω–∞ parent –ø—Ä–æ—Ü–µ—Å–∞,
–∫–æ–π—Ç–æ –æ—Ç —Å–≤–æ—è —Å—Ç—Ä–∞–Ω–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ XOR-–Ω–µ –≤—Å–∏—á–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ –∏ –¥–∞ –∏–∑–≤–µ–¥–µ –ø–æ–ª—É—á–µ–Ω–æ—Ç–æ —á–∏—Å–ª–æ –≤
—Å–ª–µ–¥–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç:
result: 573B
–ó–∞–±–µ–ª–µ–∂–∫–∞: –° –ø—ä–ª–µ–Ω –±—Ä–æ–π —Ç–æ—á–∫–∏ —Å–µ –æ—Ü–µ–Ω—è–≤–∞—Ç —Ä–µ—à–µ–Ω–∏—è, –≤ –∫–æ–∏—Ç–æ child –ø—Ä–æ—Ü–µ—Å–∏—Ç–µ —Ä–∞–±–æ—Ç—è—Ç –ø–∞—Ä–∞–ª–µ–ª–Ω–æ

#include <unistd.h>
#include <err.h>
#include <stdint.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

typedef struct{
    uint32_t offset;
    uint32_t length;
} Entry;

int main(int argc,char* argv[]){
    if(argc != 2){
        errx(1,"Invalid argument count!");
    }

    int fd1 = open(argv[1],O_RDONLY);
    if(fd1 == -1){
        err(2,"Cannot open %s",argv[1]);
    }

    int p[2];
    if(pipe(p) == -1){
        close(fd1);
        err(5,"pipe");
    }

    ssize_t sizeF;
    char filename[8];

    // –ë—Ä–æ–π –Ω–∞ child –ø—Ä–æ—Ü–µ—Å–∏—Ç–µ
    int child_count = 0;

    while((sizeF = read(fd1,&filename,sizeof(filename))) > 0){
       if(sizeF != 8){
            err(3,"Not 8 bytes!");
       }

        Entry entry;
        if(read(fd1,&entry,sizeof(entry)) != sizeof(entry)){
            close(fd1);
            close(p[0]);close(p[1]);
            err(4,"Error reading entry!");
        }

        int pid = fork();
        if(pid == -1){
            close(fd1);
            close(p[0]);close(p[1]);
            err(5,"fork");
        }

        if(pid == 0){
            // child
            close(p[0]); // –Ω–µ –∏–∑–ø–æ–ª–∑–≤–∞ —á–µ—Ç–µ–Ω–µ –æ—Ç pipe

            char fname[9];
            memcpy(fname, filename, 8);
            fname[8] = '\0';

            int file = open(fname, O_RDONLY);
            if(file == -1){
                close(p[1]);
                err(6,"Opening file");
            }

            lseek(file, entry.offset * sizeof(uint16_t), SEEK_SET);

            uint16_t a, sum = 0;
            ssize_t s;
            while(entry.length > 0 && (s = read(file, &a, sizeof(uint16_t))) == sizeof(uint16_t)){
                sum ^= a;
                entry.length--;
            }
            if(s == -1){
                close(file);
                close(p[1]);
                err(7,"reading file");
            }

            close(file);

            if(write(p[1], &sum, sizeof(sum)) == -1){
                close(p[1]);
                err(8,"writing to pipe");
            }
            close(p[1]);
            exit(0);
        }

        child_count++;
    }

    if(sizeF == -1){
        close(p[0]); close(p[1]); close(fd1);
        err(9,"reading from %s",argv[1]);
    }

    close(fd1);
    close(p[1]); // parent –Ω–µ –ø–∏—à–µ

    // Parent —á–µ—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –æ—Ç –¥–µ—Ü–∞—Ç–∞
    uint16_t S = 0, tmp;
    for(int i = 0; i < child_count; i++){
        if(read(p[0], &tmp, sizeof(tmp)) != sizeof(tmp)){
            close(p[0]);
            err(10,"Reading from pipe failed");
        }
        S ^= tmp;
    }
    close(p[0]);

    // –ò–∑—á–∞–∫–≤–∞–º–µ –≤—Å–∏—á–∫–∏ –¥–µ—Ü–∞
    while(wait(NULL) > 0);

    printf("result: %X\n", S);

    return 0;
}