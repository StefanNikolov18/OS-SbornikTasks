Зад. 77 2025-SE-02
Напишете скрипт manage.sh, който управлява сървиси. Скриптът очаква да съществува environment
променливата SVC_DIR, съдържаща име на директория, в която се намират описанията на сървисите.
Всеки обикновен файл в SVC_DIR описва един сървис (имената на файловете не ни интересуват).
Файловете имат следния 
вид:
name: <име на сървис>
pidfile: <име на pid файл>
outfile: <име на файл>
comm: <shell команда>
Примерен файл (наредбата на редовете няма значение):
comm: while true; do echo ZzZ; sleep 1; done
outfile: /tmp/sleeper_out
pidfile: /tmp/sleeper_pid
name: sleeper
manage.sh трябва да може да се извиква по следните начини:
• ./manage.sh start <име на сървис> – стартира дадения сървис, което означава:
– Стартира процес: shell, изпълняващ командата (comm) на дадения сървис във фонов режим
– Записва PID-а на стартирания процес в съответния pidfile
– Пренасочва stdout и stderr в изходния файл (outfile)
– Ако сървисът вече работи, вместо гореизброените стъпки, start не прави нищо
• ./manage.sh stop <име на сървис> – убива процеса на сървиса със SIGTERM
• ./manage.sh running – изписва имената на всички сървиси, чиито процеси (спрямо pidfile)
още работят, по едно на ред, сортирани лексикографски
• ./manage.sh cleanup – изтрива PID-файловете на всички сървиси, чиито процеси не съществуват
Примерно извикване: ./manage.sh start sleeper

#!/bin/bash

# Проверки
[[ -z "$SVC_DIR" ]] && echo "SVC_DIR not set" >&2 && exit 1
[[ ! -d "$SVC_DIR" ]] && echo "SVC_DIR is not a directory" >&2 && exit 2
[[ "$#" -lt 1 ]] && echo "Usage: $0 {start|stop|running|cleanup} [service]" >&2 && exit 3

cmd="$1"
svcname="$2"

# Функция за зареждане на сървис от файл
load_svc() {
    local file="$1"
    name=""
    pidfile=""
    outfile=""
    comm=""
    while IFS=": " read -r key value; do
        case "$key" in
            name) name="$value" ;;
            pidfile) pidfile="$value" ;;
            outfile) outfile="$value" ;;
            comm) comm="$value" ;;
        esac
    done < "$file"
}

# Обхождам всички файлове в SVC_DIR
for svcfile in "$SVC_DIR"/*; do
    [[ ! -f "$svcfile" ]] && continue
    load_svc "$svcfile"

    case "$cmd" in
        start)
            [[ "$name" != "$svcname" ]] && continue
            if [[ -f "$pidfile" ]] && kill -0 "$(cat "$pidfile")" 2>/dev/null; then
                # вече работи
                exit 0
            fi
            # стартиране
            bash -c "$comm" >> "$outfile" 2>&1 &
            echo $! > "$pidfile"
            exit 0
            ;;
        stop)
            [[ "$name" != "$svcname" ]] && continue
            [[ -f "$pidfile" ]] && kill -TERM "$(cat "$pidfile")" 2>/dev/null
            exit 0
            ;;
        running)
            if [[ -f "$pidfile" ]] && kill -0 "$(cat "$pidfile")" 2>/dev/null; then
                echo "$name"
            fi
            ;;
        cleanup)
            if [[ -f "$pidfile" ]] && ! kill -0 "$(cat "$pidfile")" 2>/dev/null; then
                rm -f "$pidfile"
            fi
            ;;
        *)
            echo "Unknown command: $cmd" >&2
            exit 4
            ;;
    esac
done

# за running сортираме
[[ "$cmd" == "running" ]] && echo "" | sort
exit 0